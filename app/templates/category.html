{% extends "base.html" %}
{% block title %}{{ category }} Tests â€” HerPriceCompare{% endblock %}

{% block content %}

<nav class="breadcrumb">
  <a href="{{ url_for('main.home') }}">Home</a>
  <span class="sep">â€º</span>
  <span>{{ category }}</span>
</nav>

<div class="page-header">
  <h1>{{ category }} Tests</h1>
  <div class="sort-bar">
    <span>Sort:</span>
    <a href="?sort=price"    class="{{ 'active' if sort == 'price'    else '' }}">
      <i class="fa fa-arrow-down-1-9"></i> Lowest price
    </a>
    <a href="?sort=name"     class="{{ 'active' if sort == 'name'     else '' }}">
      <i class="fa fa-arrow-down-a-z"></i> Name
    </a>
    <a href="?sort=discount" class="{{ 'active' if sort == 'discount' else '' }}">
      <i class="fa fa-percent"></i> Best discount
    </a>
  </div>
</div>

{% if products %}
<div class="grid grid-3">
  {% for product in products %}
  <div class="card product-card" data-id="{{ product.id }}">
    <input type="checkbox" class="product-select" title="Select to compare" aria-label="Select {{ product.name }} for comparison">

    <div class="product-thumb-wrap">
      {% if product.image_url %}
      <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-thumb" loading="lazy">
      {% else %}
      <div class="product-thumb placeholder">ðŸ§ª</div>
      {% endif %}
    </div>

    <div class="product-body">
      {% if product.brand %}
      <span class="brand-badge">{{ product.brand }}</span>
      {% endif %}

      <p class="product-name">
        <a href="{{ url_for('main.product', product_id=product.id) }}">{{ product.name }}</a>
      </p>

      <div class="product-footer">
        <div class="price-big">
          {% if product.lowest_price %}
          <span class="from-label">From</span>
          ${{ "%.2f"|format(product.lowest_price) }}
          {% else %}
          <span style="font-size:.85rem;color:var(--gray-5);">Price unavailable</span>
          {% endif %}
        </div>
        <span class="retailer-pill">
          <i class="fa fa-store" style="font-size:.65rem;"></i>
          {{ product.listings|length }} store{{ 's' if product.listings|length != 1 }}
        </span>
      </div>

      <a class="btn-compare-sm" href="{{ url_for('main.product', product_id=product.id) }}">
        <i class="fa fa-scale-balanced"></i> Compare prices
      </a>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="empty-state">
  <div class="empty-icon">ðŸ§ª</div>
  <h3>No products yet</h3>
  <p>No products found in this category. Check back soon â€” we update prices regularly.</p>
</div>
{% endif %}

{# â”€â”€ Sticky compare bar â”€â”€ #}
<div class="compare-bar" id="compareBar" aria-live="polite" aria-hidden="true">
  <div class="compare-bar-left">
    <span class="compare-bar-title" id="compareCount">0 products selected</span>
    <span class="compare-bar-sub">Select up to 4 products to compare side by side</span>
  </div>
  <div class="compare-bar-actions">
    <button class="btn-clear" onclick="clearSelection()">
      <i class="fa fa-xmark"></i> Clear
    </button>
    <a class="btn-compare" id="compareLink" href="/compare">
      <i class="fa fa-scale-balanced"></i> Compare now
    </a>
  </div>
</div>

<script>
(function () {
  var selected = [];
  var bar = document.getElementById('compareBar');
  var countEl = document.getElementById('compareCount');
  var link = document.getElementById('compareLink');

  document.querySelectorAll('.product-select').forEach(function (cb) {
    cb.addEventListener('change', function () {
      var id = cb.closest('.product-card').dataset.id;
      if (cb.checked) {
        if (selected.length >= 4) { cb.checked = false; return; }
        selected.push(id);
      } else {
        selected = selected.filter(function (x) { return x !== id; });
      }
      update();
    });
  });

  function update() {
    var n = selected.length;
    countEl.textContent = n + ' product' + (n !== 1 ? 's' : '') + ' selected'
      + (n >= 4 ? ' (max 4)' : '');
    link.href = '/compare?ids=' + selected.join(',');
    if (n >= 2) {
      bar.classList.add('visible');
      bar.setAttribute('aria-hidden', 'false');
    } else {
      bar.classList.remove('visible');
      bar.setAttribute('aria-hidden', 'true');
    }
  }

  window.clearSelection = function () {
    selected = [];
    document.querySelectorAll('.product-select').forEach(function (cb) { cb.checked = false; });
    update();
  };
}());
</script>

{% endblock %}

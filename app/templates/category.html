{% extends "base.html" %}
{% block title %}{{ category }} Tests â€” WH Price Comparison{% endblock %}

{% block content %}
<nav class="breadcrumb">
  <a href="{{ url_for('main.home') }}">Home</a> &rsaquo; {{ category }}
</nav>

<div class="page-header">
  <h1>{{ category }} Tests</h1>
  <div class="sort-bar">
    Sort by:
    <a href="?sort=price"    class="{{ 'active' if sort == 'price' }}">Lowest price</a>
    <a href="?sort=name"     class="{{ 'active' if sort == 'name' }}">Name</a>
    <a href="?sort=discount" class="{{ 'active' if sort == 'discount' }}">Biggest discount</a>
  </div>
</div>

{% if products %}
<div class="grid grid-3">
  {% for product in products %}
  <div class="card product-card" data-id="{{ product.id }}">
    <input type="checkbox" class="product-select" title="Select to compare" aria-label="Select {{ product.name }} for comparison">

    {% if product.image_url %}
    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-thumb" loading="lazy">
    {% else %}
    <div class="product-thumb placeholder">ðŸ§ª</div>
    {% endif %}

    <div class="product-info">
      <span class="brand">{{ product.brand }}</span>
      <h3><a href="{{ url_for('main.product', product_id=product.id) }}">{{ product.name }}</a></h3>

      {% if product.lowest_price %}
      <p class="price">From <strong>${{ "%.2f"|format(product.lowest_price) }}</strong></p>
      {% else %}
      <p class="price out-of-stock">Out of stock</p>
      {% endif %}

      <p class="retailer-count">{{ product.listings|length }} retailer{{ 's' if product.listings|length != 1 }}</p>

      <div class="card-actions">
        <a class="btn btn-primary" href="{{ url_for('main.product', product_id=product.id) }}">Compare prices</a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <p>No products found in this category yet.</p>
</div>
{% endif %}

<!-- Sticky compare bar â€” appears when 2â€“4 products are selected -->
<div class="compare-bar" id="compareBar" aria-live="polite" aria-hidden="true">
  <span id="compareCount">0 products selected</span>
  <div style="display:flex;gap:.75rem;align-items:center;">
    <button class="btn-clear" onclick="clearSelection()">Clear</button>
    <a class="btn-compare" id="compareLink" href="/compare">Compare</a>
  </div>
</div>

<script>
(function () {
  var selected = [];
  var bar = document.getElementById('compareBar');
  var countEl = document.getElementById('compareCount');
  var link = document.getElementById('compareLink');

  document.querySelectorAll('.product-select').forEach(function (cb) {
    cb.addEventListener('change', function () {
      var id = cb.closest('.product-card').dataset.id;
      if (cb.checked) {
        if (selected.length >= 4) { cb.checked = false; return; }
        selected.push(id);
      } else {
        selected = selected.filter(function (x) { return x !== id; });
      }
      update();
    });
  });

  function update() {
    var n = selected.length;
    countEl.textContent = n + ' product' + (n !== 1 ? 's' : '') + ' selected'
      + (n >= 4 ? ' (max)' : '');
    link.href = '/compare?ids=' + selected.join(',');
    if (n >= 2) {
      bar.classList.add('visible');
      bar.setAttribute('aria-hidden', 'false');
    } else {
      bar.classList.remove('visible');
      bar.setAttribute('aria-hidden', 'true');
    }
  }

  window.clearSelection = function () {
    selected = [];
    document.querySelectorAll('.product-select').forEach(function (cb) { cb.checked = false; });
    update();
  };
}());
</script>
{% endblock %}

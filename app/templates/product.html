{% extends "base.html" %}
{% block title %}{{ product.name }} â€” HerPriceCompare{% endblock %}

{% block content %}

<nav class="breadcrumb">
  <a href="{{ url_for('main.home') }}">Home</a>
  <span class="sep">â€º</span>
  <a href="{{ url_for('main.category', category_name=product.category) }}">{{ product.category }}</a>
  <span class="sep">â€º</span>
  <span>{{ product.name }}</span>
</nav>

{# â”€â”€ Product hero â”€â”€ #}
<div class="product-hero">
  <div class="product-hero-img-wrap">
    {% if product.image_url %}
    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-hero-img">
    {% else %}
    <div class="product-hero-img placeholder">ðŸ§ª</div>
    {% endif %}
  </div>

  <div class="product-hero-info">
    {% if product.brand %}
    <span class="brand-badge">{{ product.brand }}</span>
    {% endif %}

    <h1>{{ product.name }}</h1>
    <span class="badge badge-pink" style="margin-bottom:.5rem;">{{ product.category }}</span>

    {% if product.lowest_price %}
    <div class="hero-price-row">
      <span class="hero-price">${{ "%.2f"|format(product.lowest_price) }}</span>
      <span class="hero-price-from">best available price</span>
    </div>
    {% endif %}

    {% if product.description %}
    <p class="description">{{ product.description }}</p>
    {% endif %}

    {% if product.tag_list %}
    <div class="tags">
      {% for tag in product.tag_list %}<span class="tag">{{ tag }}</span>{% endfor %}
    </div>
    {% endif %}
  </div>
</div>

{# â”€â”€ Price comparison table â”€â”€ #}
<section class="price-table-section">
  <h2><i class="fa fa-store" style="color:var(--pink);margin-right:.4rem;font-size:.9rem;"></i>Where to buy</h2>

  {% if listings %}
  {% set max_price = listings | map(attribute='price') | max %}
  <table class="price-table">
    <thead>
      <tr>
        <th>Retailer</th>
        <th>Price</th>
        <th>Price comparison</th>
        <th>Original</th>
        <th>Discount</th>
        <th>Stock</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for listing in listings %}
      <tr class="{{ 'best-price' if loop.first and listing.in_stock }}">
        <td>
          <span class="retailer-name">
            {% if listing.retailer_logo %}
            <img src="{{ listing.retailer_logo }}" alt="" class="retailer-logo">
            {% endif %}
            {{ listing.retailer }}
          </span>
          {% if loop.first and listing.in_stock %}
          <br><span class="badge badge-teal" style="margin-top:.3rem;"><i class="fa fa-crown" style="font-size:.65rem;"></i> Best price</span>
          {% endif %}
        </td>
        <td class="price-cell">${{ "%.2f"|format(listing.price) }}</td>
        <td>
          <div class="price-bar-wrap">
            <div class="price-bar">
              <div class="price-bar-fill" style="width: {{ ((listing.price / max_price) * 100) | round | int }}%;"></div>
            </div>
          </div>
        </td>
        <td class="orig-price">
          {% if listing.original_price %}${{ "%.2f"|format(listing.original_price) }}{% else %}&mdash;{% endif %}
        </td>
        <td>
          {% if listing.discount_pct %}
          <span class="badge badge-orange"><i class="fa fa-tag" style="font-size:.65rem;"></i> -{{ listing.discount_pct }}%</span>
          {% else %}&mdash;{% endif %}
        </td>
        <td>
          {% if listing.in_stock %}
          <span class="badge badge-green"><i class="fa fa-circle-check" style="font-size:.65rem;"></i> In stock</span>
          {% else %}
          <span class="badge badge-red"><i class="fa fa-circle-xmark" style="font-size:.65rem;"></i> Out of stock</span>
          {% endif %}
        </td>
        <td>
          <a class="btn btn-primary" href="{{ listing.url }}" target="_blank" rel="noopener noreferrer">
            Buy <i class="fa fa-arrow-up-right-from-square" style="font-size:.75rem;"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <p class="disclaimer">
    <i class="fa fa-clock" style="font-size:.7rem;"></i>
    Prices last checked {{ listings[0].scraped_at.strftime('%b %d, %Y at %H:%M UTC') if listings else '' }}.
    Always verify on the retailer's site before purchasing.
  </p>
  {% else %}
  <div class="empty-state" style="border:none;padding:2rem 0;">
    <div class="empty-icon">ðŸ›’</div>
    <h3>No listings available</h3>
    <p>We don't have current pricing data for this product yet.</p>
  </div>
  {% endif %}
</section>

{# â”€â”€ Related products â”€â”€ #}
{% if related %}
<section class="related-products" style="margin-top:2rem;">
  <div class="section-header">
    <h2>Also in {{ product.category }}</h2>
    <a class="section-link" href="{{ url_for('main.category', category_name=product.category) }}">
      View all <i class="fa fa-arrow-right" style="font-size:.75rem;"></i>
    </a>
  </div>
  <div class="grid grid-4">
    {% for p in related %}
    <div class="card product-card-sm">
      <h4><a href="{{ url_for('main.product', product_id=p.id) }}">{{ p.name }}</a></h4>
      {% if p.lowest_price %}
      <p class="price-sm">From ${{ "%.2f"|format(p.lowest_price) }}</p>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

{% endblock %}

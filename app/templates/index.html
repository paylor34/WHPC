{% extends "base.html" %}
{% block title %}Women's Health At-Home Test Price Comparison â€” HerPriceCompare{% endblock %}

{% block content %}

{# â”€â”€ Hero â”€â”€ #}
<section class="hero">
  <div class="hero-content">
    <h1>Compare prices on women's health at-home tests</h1>
    <p>Find the best deals across CVS, Walgreens, Amazon, Everlywell, LetsGetChecked, and more â€” all in one place.</p>

    {% if categories %}
    <div class="hero-stats">
      <div class="hero-stat">
        <span class="stat-val">{{ categories|sum(attribute='count') }}</span>
        <span class="stat-label">Products tracked</span>
      </div>
      <div class="hero-divider"></div>
      <div class="hero-stat">
        <span class="stat-val">{{ categories|length }}</span>
        <span class="stat-label">Categories</span>
      </div>
      <div class="hero-divider"></div>
      <div class="hero-stat">
        <span class="stat-val">8+</span>
        <span class="stat-label">Retailers compared</span>
      </div>
    </div>
    {% endif %}
  </div>
</section>

{# â”€â”€ Category grid â”€â”€ #}
<section class="category-grid">
  <div class="section-header">
    <h2>Browse by category</h2>
  </div>

  {% set cat_icons = {
    "Pregnancy":          {"emoji": "ğŸ¤°", "bg": "#fce4f0"},
    "Ovulation & Fertility": {"emoji": "ğŸŒ¸", "bg": "#ede9fe"},
    "STI / STD":          {"emoji": "ğŸ›¡ï¸", "bg": "#d1faf5"},
    "Menopause & FSH":    {"emoji": "ğŸŒ¡ï¸", "bg": "#ffedd5"},
    "Thyroid":            {"emoji": "ğŸ¦‹", "bg": "#fef9c3"},
    "Hormone Panel":      {"emoji": "âš—ï¸", "bg": "#ede9fe"},
    "UTI":                {"emoji": "ğŸ’§", "bg": "#dbeafe"},
    "Vaginal Health":     {"emoji": "ğŸŒº", "bg": "#fce4f0"},
    "PCOS":               {"emoji": "ğŸ’œ", "bg": "#ede9fe"},
    "Breast Cancer Risk": {"emoji": "ğŸ—ï¸", "bg": "#fce4f0"},
    "General Wellness":   {"emoji": "ğŸ’Š", "bg": "#dcfce7"}
  } %}

  {% if categories %}
  <div class="grid grid-3">
    {% for cat in categories %}
    {% set icon_data = cat_icons.get(cat.name, {"emoji": "ğŸ§ª", "bg": "#f3f4f6"}) %}
    <a class="card category-card" href="{{ url_for('main.category', category_name=cat.name) }}">
      <div class="category-icon" style="background: {{ icon_data.bg }};">
        {{ icon_data.emoji }}
      </div>
      <h3>{{ cat.name }}</h3>
      <p class="count">{{ cat.count }} product{{ 's' if cat.count != 1 }}</p>
      {% if cat.min_price %}
      <p class="price-from">From <strong>${{ "%.2f"|format(cat.min_price) }}</strong></p>
      {% endif %}
      <span class="cat-arrow">View products â†’</span>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">ğŸ§ª</div>
    <h3>No products yet</h3>
    <p>Run a scrape to populate the database:</p>
    <pre>python run.py seed</pre>
  </div>
  {% endif %}
</section>

{# â”€â”€ Data freshness (collapsed, low visual weight) â”€â”€ #}
{% if recent_logs or scheduled_jobs %}
<section class="scrape-status">
  <h2><i class="fa fa-circle-check" style="color:var(--teal);font-size:.85rem;"></i> Data freshness</h2>

  {% if scheduled_jobs %}
  <div class="scheduler-bar">
    <span class="badge badge-teal">â— Live updates</span>
    {% for job in scheduled_jobs %}
    <span class="scheduler-job">
      <strong>{{ job.name }}</strong> â€” next refresh:
      {% if job.next_run %}
        {{ job.next_run.strftime('%b %d at %H:%M UTC') }}
      {% else %}
        unknown
      {% endif %}
    </span>
    {% endfor %}
  </div>
  {% endif %}

  {% if recent_logs %}
  <table>
    <thead><tr><th>Source</th><th>Retailer</th><th>Found</th><th>Updated</th><th>When</th><th></th></tr></thead>
    <tbody>
    {% for log in recent_logs %}
    <tr>
      <td><span class="badge {{ 'badge-teal' if log.success else 'badge-red' }}">{{ log.source }}</span></td>
      <td>{{ log.retailer }}</td>
      <td>{{ log.products_found }}</td>
      <td>{{ log.products_updated }}</td>
      <td>{{ log.started_at.strftime('%b %d %H:%M') }}</td>
      <td>{% if not log.success %}<span class="badge badge-red" title="{{ log.errors }}">error</span>{% endif %}</td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
</section>
{% endif %}

{% endblock %}
